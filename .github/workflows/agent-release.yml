name: Agent Release

on:
  push:
    tags:
      - "agent-v*"

permissions:
  contents: write

jobs:
  test:
    name: Test Agent
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/agent
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: apps/agent/go.mod

      - name: Run tests
        run: go test ./...

  build:
    name: Package ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: apps/agent
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: linux
            arch: armv7
            goarch: arm
            goarm: "7"
          - os: linux
            arch: mips
            gomips: softfloat
          - os: linux
            arch: mipsle
            gomips: softfloat
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: apps/agent/go.mod

      - name: Build archive
        env:
          CGO_ENABLED: "0"
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.goarch || matrix.arch }}
          GOARM: ${{ matrix.goarm || '' }}
          GOMIPS: ${{ matrix.gomips || '' }}
          VERSION: ${{ github.ref_name }}
        run: |
          set -eu
          mkdir -p dist/release
          workdir="dist/pkg"
          rm -rf "$workdir"
          mkdir -p "$workdir"

          VERSION_PLAIN="${VERSION#agent-v}"
          go build -trimpath \
            -ldflags "-s -w -X github.com/foru17/neko-master/apps/agent/internal/config.AgentVersion=${VERSION_PLAIN}" \
            -o "$workdir/neko-agent" .
          chmod +x "$workdir/neko-agent"

          versioned_archive="neko-agent_${VERSION}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz"
          latest_archive="neko-agent_${{ matrix.os }}_${{ matrix.arch }}.tar.gz"
          tar -C "$workdir" -czf "dist/release/$versioned_archive" neko-agent
          cp "dist/release/$versioned_archive" "dist/release/$latest_archive"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-release-${{ matrix.os }}-${{ matrix.arch }}
          path: apps/agent/dist/release/*.tar.gz

  checksums:
    name: Generate checksums
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/release
          pattern: agent-release-*
          merge-multiple: true

      - name: Create checksums file
        run: |
          set -eu
          cd dist/release
          sha256sum *.tar.gz > checksums.txt

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: agent-release-checksums
          path: dist/release/checksums.txt

  publish:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - checksums
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/release
          pattern: agent-release-*
          merge-multiple: true

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/release/*.tar.gz
            dist/release/checksums.txt
