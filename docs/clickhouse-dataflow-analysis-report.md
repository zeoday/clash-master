# ClickHouse æ•°æ®æµæ¶æ„æ·±åº¦åˆ†ææŠ¥å‘Š

> åˆ†æç‰ˆæœ¬: å½“å‰å¼€å‘åˆ†æ”¯ vs mainåˆ†æ”¯  
> åˆ†æé‡ç‚¹: å¼•å…¥ ClickHouse åçš„æ•°æ®æµå®Œæ•´é“¾è·¯åŠ IO æ€§èƒ½ä¼˜åŒ–  
> ç”Ÿæˆæ—¶é—´: 2026-02-20

---

## ä¸€ã€æ•´ä½“æ•°æ®æµæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    æ•°æ®æºå¤´ (Data Source)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Clash Gateway  â”‚  â”‚  Surge Gateway  â”‚  â”‚  Agent æ¨¡å¼     â”‚  â”‚  å…¶ä»–ä»£ç†åç«¯    â”‚     â”‚
â”‚  â”‚  (WebSocket)    â”‚  â”‚  (HTTP API)     â”‚  â”‚  (è¢«åŠ¨æ¥æ”¶)      â”‚  â”‚                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                    â”‚                    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  æ•°æ®é‡‡é›†å±‚ (Collector)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         GatewayCollector / SurgeCollector                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â”‚
â”‚  â”‚  â”‚  WebSocketè¿æ¥   â”‚  â”‚  æ¶ˆæ¯è§£æ        â”‚  â”‚  è¿æ¥çŠ¶æ€è·Ÿè¸ª    â”‚                 â”‚   â”‚
â”‚  â”‚  â”‚  (å®æ—¶æµé‡æ•°æ®)  â”‚  â”‚  (Deltaè®¡ç®—)    â”‚  â”‚  (activeConnections Map) â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚  â”‚           â”‚                    â”‚                    â”‚                           â”‚   â”‚
â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚  â”‚                                â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                      BatchBuffer (å†…å­˜æ‰¹å¤„ç†ç¼“å†²åŒº)                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  buffer (Map)   â”‚  â”‚  geoQueue       â”‚  â”‚  èšåˆè®¡ç®—        â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  æŒ‰å¤åˆé”®å»é‡    â”‚  â”‚  GeoIPç»“æœé˜Ÿåˆ—   â”‚  â”‚  (ç›¸åŒé”®æµé‡åˆå¹¶) â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Key: backendId â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  + minute + ... â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®æ—¶å†…å­˜ç¼“å­˜å±‚ (Realtime Cache)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         RealtimeStore (å•ä¾‹æ¨¡å¼)                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ summaryByBackend â”‚ minuteByBackend â”‚ domainByBackend â”‚ ipByBackend â”‚ proxyByBackend â”‚ â”‚
â”‚  â”‚  â”‚   (æ±‡æ€»)    â”‚   (åˆ†é’Ÿæ¡¶)    â”‚   (åŸŸåç»Ÿè®¡)  â”‚   (IPç»Ÿè®¡)   â”‚  (ä»£ç†ç»Ÿè®¡)  â”‚ â”‚
â”‚  â”‚  â”‚  Map<number,> â”‚  Map<number,>  â”‚  Map<number,>  â”‚  Map<number,>  â”‚ Map<number,> â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                                  â”‚   â”‚
â”‚  â”‚  å†…å­˜é™åˆ¶: MAX_DOMAIN_ENTRIES=50K, MAX_IP_ENTRIES=50K, MAX_RULE_CHAIN_ENTRIES=50K â”‚   â”‚
â”‚  â”‚  ä¿ç•™ç­–ç•¥: maxMinutes=180åˆ†é’Ÿ (å¯é…ç½®), å®šæœŸ prune æ—§æ•°æ®                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•°æ®å†™å…¥å±‚ (Write Layer) - åŒå†™æ¶æ„                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           SQLite (Primary)              â”‚    â”‚         ClickHouse (Analytics)      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚    TrafficWriterRepository      â”‚   â”‚    â”‚  â”‚      ClickHouseWriter       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  batchUpdateTrafficStats â”‚   â”‚   â”‚    â”‚  â”‚  â”‚   å†™å…¥é˜Ÿåˆ—æ§åˆ¶        â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ domainMap (èšåˆ)     â”‚   â”‚   â”‚    â”‚  â”‚  â”‚  maxPendingBatches  â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ ipMap (èšåˆ)         â”‚   â”‚   â”œâ”€â”€â”€â–ºâ”‚  â”‚  â”‚  maxPendingRows     â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ chainMap (èšåˆ)      â”‚   â”‚   â”‚    â”‚  â”‚  â”‚  writeChain (ä¸²è¡Œ)  â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ ruleProxyMap (èšåˆ)  â”‚   â”‚   â”‚    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ minuteDimMap (èšåˆ)  â”‚   â”‚   â”‚    â”‚  â”‚                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ hourlyDimMap (èšåˆ)  â”‚   â”‚   â”‚    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ deviceMap (èšåˆ)     â”‚   â”‚   â”‚    â”‚  â”‚  â”‚    ä¸‰å¼ ç›®æ ‡è¡¨        â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  ... å…±17ä¸ªèšåˆMap    â”‚   â”‚   â”‚    â”‚  â”‚  â”‚  traffic_agg_buffer â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚                        â”‚   â”‚   â”‚    â”‚  â”‚  â”‚  traffic_detail_bufferâ”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ 3ä¸ªTransactionæ‰¹é‡å†™å…¥â”‚   â”‚   â”‚    â”‚  â”‚  â”‚  country_buffer     â”‚   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                  â”‚   â”‚    â”‚  â”‚                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  WALæ¨¡å¼ + NORMALåŒæ­¥ + å†…å­˜ç¼“å­˜  â”‚   â”‚    â”‚  â”‚  å†™å…¥æ–¹å¼: HTTP JSONEachRow â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  busy_timeout=5000ms             â”‚   â”‚    â”‚  â”‚  æ‰¹é‡å¤§å°: åŠ¨æ€            â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                        â”‚    â”‚                                    â”‚ â”‚
â”‚  â”‚  âš ï¸ å½“ CH_ONLY_MODE=1 æ—¶å¯è·³è¿‡SQLiteç»Ÿè®¡å†™å…¥ â”‚    â”‚  âš ï¸ é˜Ÿåˆ—æ»¡æ—¶ä¸¢å¼ƒæ—§æ‰¹æ¬¡ (é˜²OOM)     â”‚ â”‚
â”‚  â”‚  âš ï¸ reduceWrites=true æ—¶ç²¾ç®€SQLiteå†™å…¥      â”‚    â”‚  âš ï¸ å¤±è´¥æ—¶ä¿ç•™Realtimeæ•°æ®         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•°æ®æŸ¥è¯¢å±‚ (Query Layer) - è·¯ç”±æ¶æ„                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                              StatsService                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚  è·¯ç”±å†³ç­–é€»è¾‘    â”‚â”€â”€â”€â–ºâ”‚  shouldUseClickHouse()                    â”‚             â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚    â”‚  â”œâ”€ timeRange.active?                     â”‚             â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚    â”‚  â”œâ”€ STATS_QUERY_SOURCE (sqlite/clickhouse/auto) â”‚        â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚    â”‚  â””â”€ ClickHouseå¯ç”¨æ€§æ£€æŸ¥                   â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚           â”‚                                                                      â”‚   â”‚
â”‚  â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â”‚           â–¼                    â–¼                    â–¼                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â”‚
â”‚  â”‚  â”‚   SQLite Path   â”‚  â”‚ ClickHouse Path â”‚  â”‚   Fallbacké€»è¾‘   â”‚                 â”‚   â”‚
â”‚  â”‚  â”‚  (StatsDatabase)â”‚  â”‚(ClickHouseReader)â”‚  â”‚  (CH_STRICT_STATS)â”‚                â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚                  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ 17+å¼ ç»Ÿè®¡è¡¨ â”‚  â”‚  â”œâ”€ è¯»å–Bufferè¡¨ â”‚  â”‚  â”œâ”€ éƒ¨åˆ†å¤±è´¥å›é€€ â”‚                  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ UPSERTæŸ¥è¯¢  â”‚  â”‚  â”œâ”€ ç‰©åŒ–è§†å›¾     â”‚  â”‚  â”œâ”€ åŸå­æ€§æ£€æŸ¥   â”‚                  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ ç´¢å¼•ä¼˜åŒ–    â”‚  â”‚  â”œâ”€ èšåˆæŸ¥è¯¢     â”‚  â”‚  â””â”€ SQLiteå…œåº•   â”‚                  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ åˆ†é¡µ/æ’åº   â”‚  â”‚  â””â”€ å®æ—¶æ•°æ®åˆå¹¶ â”‚  â”‚                 â”‚                  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚  â”‚                                                                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                    Realtimeæ•°æ®åˆå¹¶ (Merger)                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  æŸ¥è¯¢ç»“æœ + RealtimeStore.applySummaryDelta() / mergeTopDomains()       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  è§£å†³ClickHouseåˆ†é’Ÿçº§å»¶è¿Ÿé—®é¢˜ï¼Œæä¾›ç§’çº§å®æ—¶æ€§                            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€å„ç¯èŠ‚è¯¦ç»†åˆ†æ

### 2.1 æ•°æ®æºå¤´ï¼ˆData Sourceï¼‰

**ç»„ä»¶**: `GatewayCollector`, `SurgeCollector`

**å…³é”®æœºåˆ¶**:
- **WebSocket è¿æ¥**: ä¸ Clash/Surge ç½‘å…³å»ºç«‹æŒä¹…è¿æ¥ï¼Œå®æ—¶æ¥æ”¶è¿æ¥æ•°æ®
- **Delta è®¡ç®—**: å¯¹æ¯” `lastUpload/lastDownload` è®¡ç®—å¢é‡æµé‡ï¼Œé¿å…é‡å¤ç»Ÿè®¡
- **è¿æ¥çŠ¶æ€è·Ÿè¸ª**: `activeConnections Map` è·Ÿè¸ªæ¯ä¸ªè¿æ¥çš„æœ€æ–°çŠ¶æ€ï¼Œæ¸…ç†è¿‡æœŸè¿æ¥ï¼ˆ5åˆ†é’Ÿè¶…æ—¶ï¼‰

**æ½œåœ¨é—®é¢˜**:
1. **è¿æ¥çŠ¶æ€å†…å­˜å ç”¨**: é«˜å¹¶å‘åœºæ™¯ä¸‹ `activeConnections` å¯èƒ½å ç”¨å¤§é‡å†…å­˜
2. **GeoIP æŸ¥è¯¢é˜»å¡**: å½“å‰æ˜¯åŒæ­¥æŸ¥è¯¢ GeoIPï¼Œè™½ç„¶å·²æ”¹ä¸ºæ‰¹é‡ä½†ä»æœ‰ä¼˜åŒ–ç©ºé—´

---

### 2.2 æ•°æ®å¤„ç†ï¼ˆBatchBufferï¼‰

**å…³é”®ä¼˜åŒ–**:
```typescript
// å¤åˆé”®å»é‡èšåˆ
const key = [
  backendId, minuteKey, domain, ip, chain, 
  fullChain, rule, rulePayload, sourceIP
].join(":");
```

**è®¾è®¡äº®ç‚¹**:
- **å†…å­˜èšåˆ**: åŒä¸€åˆ†é’Ÿå†…ç›¸åŒç»´åº¦çš„æµé‡ä¼šè¢«åˆå¹¶ï¼Œå‡å°‘ä¸‹æ¸¸å†™å…¥å‹åŠ›
- **åŒé˜Ÿåˆ—è®¾è®¡**: `buffer` (æµé‡æ•°æ®) + `geoQueue` (GeoIPç»“æœ)

**IO ç›¸å…³ä¼˜åŒ–**:
- `FLUSH_INTERVAL_MS=30000` (30ç§’åˆ·æ–°ä¸€æ¬¡)
- `FLUSH_MAX_BUFFER_SIZE=5000` (è¾¾åˆ°5000æ¡ç«‹å³åˆ·æ–°)

---

### 2.3 å­˜å‚¨å±‚ - SQLiteï¼ˆPrimary Storageï¼‰

**Schema åˆ†æ**:
å…±æœ‰ **22å¼ è¡¨**ï¼Œæ ¸å¿ƒè¡¨åŒ…æ‹¬:
- `minute_dim_stats` / `hourly_dim_stats`: åˆ†é’Ÿ/å°æ—¶çº§äº‹å®è¡¨ï¼ˆæœ€ç»†ç²’åº¦ï¼‰
- `domain_stats` / `ip_stats`: èšåˆç»Ÿè®¡è¡¨
- `rule_chain_traffic` / `rule_domain_traffic`: è§„åˆ™å…³è”è¡¨
- `device_stats`: è®¾å¤‡ç»Ÿè®¡

**IO ä¼˜åŒ–æªæ–½**:
```typescript
// db.ts ä¸­çš„åˆå§‹åŒ–é…ç½®
this.db.pragma('journal_mode = WAL');        // WALæ¨¡å¼ï¼Œè¯»å†™ä¸é˜»å¡
this.db.pragma('synchronous = NORMAL');      // é™ä½åŒæ­¥é¢‘ç‡
this.db.pragma('wal_autocheckpoint = 1000'); // æ§åˆ¶WALæ–‡ä»¶å¤§å°
this.db.pragma('temp_store = MEMORY');       // ä¸´æ—¶è¡¨æ”¾å†…å­˜
this.db.pragma('cache_size = -65536');       // 64MBç¼“å­˜
this.db.pragma('busy_timeout = 5000');       // 5ç§’è¶…æ—¶
```

**æ‰¹é‡å†™å…¥ç­–ç•¥** (`TrafficWriterRepository`):
```typescript
// å†…å­˜é¢„èšåˆï¼š17ä¸ª Map è¿›è¡Œç»´åº¦èšåˆ
const domainMap = new Map();
const ipMap = new Map();
const chainMap = new Map();
// ... ç­‰ç­‰

// 3ä¸ªå­äº‹åŠ¡æ‰¹é‡å†™å…¥
tx1(); // Core aggregation tables
tx2(); // Detail tables + minute/hourly tables  
tx3(); // Device tables (æ¡ä»¶æ‰§è¡Œ)
```

**reduceWrites æ¨¡å¼**:
å½“ ClickHouse å¯ç”¨æ—¶ï¼Œå¯ä»¥é€šè¿‡ `reduceWrites=true` ç²¾ç®€ SQLite å†™å…¥:
- **ä¿ç•™**: `hourly_stats`, `proxy_stats`ï¼ˆè½»é‡çº§ï¼‰
- **è·³è¿‡**: `domain_stats`, `ip_stats`, `rule_*_traffic` ç­‰è¯¦ç»†è¡¨

---

### 2.4 å­˜å‚¨å±‚ - ClickHouseï¼ˆAnalytics Storageï¼‰

**è¡¨ç»“æ„è®¾è®¡**:

| è¡¨å | å¼•æ“ | ç”¨é€” | åˆ†åŒºç­–ç•¥ |
|------|------|------|----------|
| `traffic_agg` | SummingMergeTree | æ±‡æ€»/è¶‹åŠ¿/å°æ—¶æŸ¥è¯¢ | toYYYYMM(minute) |
| `traffic_detail` | MergeTree | Top-N/è¿‡æ»¤/è§„åˆ™é“¾æŸ¥è¯¢ | toYYYYMM(minute) |
| `country_minute` | SummingMergeTree | å›½å®¶ç»Ÿè®¡ | toYYYYMM(minute) |
| `*_buffer` | Buffer | å†…å­˜ç¼“å†²è¡¨ | - |

**Buffer è¡¨é…ç½®** (å…³é”®IOä¼˜åŒ–):
```sql
ENGINE = Buffer(
  'neko_master', 'traffic_agg', 4,  -- 4å±‚å¹¶å‘
  10, 60,    -- min/max æ—¶é—´: 10-60ç§’
  100, 10000, -- min/max è¡Œæ•°: 100-10000
  10000, 1000000 -- min/max å­—èŠ‚: 10KB-1MB
)
```

**Buffer è¡¨çš„ä½œç”¨**:
- å°† INSERT é¢‘ç‡ä» ~40æ¬¡/åˆ†é’Ÿ é™ä½åˆ° ~2æ¬¡/åˆ†é’Ÿ
- å¤§å¹…å‡å°‘ ClickHouse åå° Merge æ“ä½œçš„ I/O å‹åŠ›
- æ•°æ®å…ˆå†™å…¥å†…å­˜ï¼Œæ»¡è¶³æ¡ä»¶åè‡ªåŠ¨åˆ·ç›˜

---

### 2.5 æŸ¥è¯¢è·¯ç”±å±‚ï¼ˆStatsServiceï¼‰

**è·¯ç”±å†³ç­–é€»è¾‘**:
```typescript
private shouldUseClickHouse(timeRange: TimeRange): boolean {
  return (
    timeRange.active &&                              // å¿…é¡»æ¿€æ´»æ—¶é—´èŒƒå›´
    this.clickHouseReader.shouldUseForRange(start, end)  // CHå¯ç”¨ä¸”èŒƒå›´æœ‰æ•ˆ
  );
}
```

**Fallback ç­–ç•¥**:
```typescript
// getSummaryWithRouting ä¸­çš„åŸå­æ€§æ£€æŸ¥
const allCHReady = !!summaryCH && !!topDomainsCH && ...;
if (!allCHReady) {
  // ä»»ä¸€æŸ¥è¯¢å¤±è´¥åˆ™æ•´ä½“å›é€€åˆ° SQLite
  return this.getSummary(backendId, timeRange);
}
```

**è·¯ç”±æŒ‡æ ‡ç»Ÿè®¡**:
- é€šè¿‡ `recordRoute()` è®°å½•æ¯ä¸ªè¯·æ±‚çš„è·¯ç”±å»å‘
- æ—¥å¿—è¾“å‡º: `summary=ch:100,sqlite:10,ch_rate:90.9%`

---

### 2.6 å®æ—¶ç¼“å­˜å±‚ï¼ˆRealtimeStoreï¼‰

**å†…å­˜ç»“æ„**:
```typescript
summaryByBackend: Map<number, SummaryDelta>
minuteByBackend: Map<number, Map<string, MinuteBucket>>
domainByBackend: Map<number, Map<string, DomainDelta>>
// ... å…±10+ä¸ªMap
```

**å…³é”®æœºåˆ¶**:
- **å†™å…¥**: æ¯æ¬¡æµé‡æ›´æ–°å®æ—¶å†™å…¥å†…å­˜
- **è¯»å–åˆå¹¶**: æŸ¥è¯¢æ—¶å°† DB ç»“æœä¸å†…å­˜æ•°æ®åˆå¹¶
- **æ¸…ç†**: `pruneOldBuckets()` å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®ï¼ˆé»˜è®¤ä¿ç•™180åˆ†é’Ÿï¼‰

**å†…å­˜ä¸Šé™ä¿æŠ¤**:
```typescript
private static readonly MAX_DOMAIN_ENTRIES = 50_000;
private static readonly MAX_IP_ENTRIES = 50_000;
```

---

## ä¸‰ã€IO æ€§èƒ½ä¼˜åŒ–ç‚¹æ·±åº¦åˆ†æ

### 3.1 âœ… å·²å®æ–½çš„ä¼˜ç§€ä¼˜åŒ–

| ä¼˜åŒ–ç‚¹ | ä½ç½® | æ•ˆæœ |
|--------|------|------|
| WAL + NORMAL æ¨¡å¼ | `db.ts:136-137` | è¯»å†™ä¸é˜»å¡ï¼Œé™ä½ fsync é¢‘ç‡ |
| å†…å­˜ç¼“å­˜é…ç½® | `db.ts:140` | 64MB SQLite ç¼“å­˜ |
| BatchBuffer å†…å­˜èšåˆ | `batch-buffer.ts:59-89` | å‡å°‘é‡å¤å†™å…¥ |
| TrafficWriter æ‰¹é‡å†™å…¥ | `traffic-writer.ts:188-348` | å•äº‹åŠ¡å¤„ç†å¤šæ¡è®°å½• |
| reduceWrites æ¨¡å¼ | `traffic-writer.ts:420-442` | CHå¯ç”¨æ—¶ç²¾ç®€SQLiteå†™å…¥ |
| Buffer è¡¨ç¼“å†² | `clickhouse.config.ts:265-301` | é™ä½CHå†™å…¥é¢‘ç‡ |
| ä¸²è¡Œå†™å…¥é˜Ÿåˆ— | `clickhouse-writer.ts:46-175` | é˜²æ­¢å¹¶å‘å‹å®ä¸‹æ¸¸ |
| RealtimeStore å†…å­˜ç¼“å­˜ | `realtime.store.ts` | å‡å°‘æŸ¥è¯¢IO |

### 3.2 âš ï¸ æ½œåœ¨ IO æ€§èƒ½é£é™©

#### é£é™©1: SQLite åŒå†™ä»é€ æˆå†™æ”¾å¤§

**é—®é¢˜æè¿°**:
è™½ç„¶ ClickHouse æ‰¿æ‹…äº†æŸ¥è¯¢ï¼Œä½† `BatchBuffer.flush()` ä»ç„¶ä¼šå°†å…¨éƒ¨æ•°æ®å†™å…¥ SQLite çš„ 17+ å¼ è¡¨ã€‚å³ä½¿å¯ç”¨äº† `reduceWrites`ï¼Œä»ç„¶éœ€è¦å†™å…¥ï¼š
- `hourly_stats`
- `proxy_stats`
- `minute_stats`
- `minute_dim_stats`
- `hourly_dim_stats`
- è®¾å¤‡ç›¸å…³è¡¨ï¼ˆæ¡ä»¶ï¼‰

**ä»£ç ä½ç½®**: `traffic-writer.ts:420-553`

**å½±å“**: é«˜é¢‘å†™å…¥æ—¶ï¼ŒWAL æ–‡ä»¶å¯èƒ½å¿«é€Ÿå¢é•¿ï¼Œcheckpoint å‹åŠ›å¢å¤§

**å»ºè®®ä¼˜åŒ–**:
1. **æ¸è¿›å¼é™çº§**: å½“ ClickHouse ç¨³å®šè¿è¡Œåï¼Œå®Œå…¨å…³é—­ SQLite ç»Ÿè®¡è¡¨å†™å…¥
2. **WAL æ–‡ä»¶ç›‘æ§**: æ·»åŠ  WAL æ–‡ä»¶å¤§å°ç›‘æ§å’Œå‘Šè­¦

---

#### é£é™©2: ClickHouse Buffer è¡¨é…ç½®å¯èƒ½ä¸å¤Ÿæ¿€è¿›

**å½“å‰é…ç½®**:
```sql
ENGINE = Buffer(..., 10, 60, 100, 10000, 10000, 1000000)
```

**åˆ†æ**:
- max_rows=10000 å¯èƒ½åœ¨é«˜å³°æ—¶æ®µé¢‘ç¹åˆ·ç›˜
- max_bytes=1MB å¯¹äºé«˜åååœºæ™¯åå°

**å»ºè®®ä¼˜åŒ–**:
```sql
-- æ›´æ¿€è¿›çš„ç¼“å†²é…ç½®ï¼ˆå¦‚æœå†…å­˜å…è®¸ï¼‰
ENGINE = Buffer(..., 30, 120, 1000, 50000, 100000, 5000000)
-- æ—¶é—´: 30-120ç§’
-- è¡Œæ•°: 1000-50000
-- å­—èŠ‚: 100KB-5MB
```

---

#### é£é™©3: RealtimeStore ç¼ºä¹æŒä¹…åŒ–ä¿æŠ¤

**é—®é¢˜æè¿°**:
RealtimeStore æ•°æ®ä»…å­˜å†…å­˜ï¼Œå¦‚æœè¿›ç¨‹å´©æºƒï¼Œæœ€è¿‘å‡ åˆ†é’Ÿçš„æ•°æ®ä¼šä¸¢å¤±ã€‚

**ä»£ç ä½ç½®**: `gateway.collector.ts:174-249`

**å½“å‰æœºåˆ¶**:
```typescript
// flushBatch ä¸­çš„å¤„ç†
if (trafficDetailOk && trafficAggOk) {
  realtimeStore.clearTraffic(id);  // æˆåŠŸåæ¸…ç†
}
```

**å»ºè®®ä¼˜åŒ–**:
1. **å¯é€‰çš„æŒä¹…åŒ–**: è€ƒè™‘å°† RealtimeStore å®šæœŸ checkpoint åˆ° SQLiteï¼ˆè½»é‡çº§è¡¨ï¼‰
2. **ä¼˜é›…å…³é—­**: ç¡®ä¿ SIGTERM æ—¶å…ˆ flush å†é€€å‡º

---

#### é£é™©4: æŸ¥è¯¢æ—¶çš„çƒ­ç‚¹æ•°æ®ç«äº‰

**é—®é¢˜æè¿°**:
`StatsDatabase` ä½¿ç”¨äº†ä¸€äº›ç¼“å­˜çš„ prepared statements (`_summaryStmts`)ï¼Œä½†åœ¨é«˜å¹¶å‘æŸ¥è¯¢æ—¶å¯èƒ½ä»æœ‰é”ç«äº‰ã€‚

**ä»£ç ä½ç½®**: `db.ts:81-83`

**å»ºè®®ä¼˜åŒ–**:
1. **è¿æ¥æ± **: è€ƒè™‘ä½¿ç”¨ `better-sqlite3` çš„è¿æ¥æ± æ¨¡å¼
2. **åªè¯»å‰¯æœ¬**: å¯¹äºçº¯æŸ¥è¯¢åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘ SQLite åªè¯»å‰¯æœ¬

---

#### é£é™©5: ClickHouse è¿æ¥æœªå¤ç”¨

**å½“å‰å®ç°**:
```typescript
// clickhouse-writer.ts:232-243
const response = await fetch(url, {
  method: 'POST',
  // ... æ¯æ¬¡æ–°å»ºè¿æ¥
});
```

**é—®é¢˜**: æ¯æ¬¡å†™å…¥éƒ½æ–°å»º HTTP è¿æ¥ï¼ŒTCP æ¡æ‰‹å¼€é”€

**å»ºè®®ä¼˜åŒ–**:
1. **HTTP Keep-Alive**: ä½¿ç”¨ `fetch` çš„ keepalive é€‰é¡¹
2. **è¿æ¥æ± **: è€ƒè™‘ä½¿ç”¨ `undici` æˆ– `http.Agent` ä¿æŒè¿æ¥

---

### 3.3 ğŸ”§ å…·ä½“ä»£ç çº§ä¼˜åŒ–å»ºè®®

#### å»ºè®®1: æ·»åŠ å†™å…¥é™çº§å¼€å…³

```typescript
// stats-write-mode.ts
export function getSQLiteWriteMode(): 'full' | 'minimal' | 'none' {
  if (!isClickHouseOnlyModeEnabled()) return 'full';
  if (process.env.CH_SQLITE_WRITE_MODE === 'minimal') return 'minimal';
  if (process.env.CH_SQLITE_WRITE_MODE === 'none') return 'none';
  return 'minimal'; // é»˜è®¤
}
```

#### å»ºè®®2: ClickHouse å†™å…¥æ·»åŠ å‹ç¼©

```typescript
// clickhouse-writer.ts
const body = rows.map((row) => JSON.stringify(row)).join('\n');
const compressed = await gzip(body); // æ·»åŠ å‹ç¼©

await fetch(url, {
  headers: {
    'Content-Encoding': 'gzip', // å¯ç”¨å‹ç¼©
  },
  body: compressed,
});
```

#### å»ºè®®3: RealtimeStore æ·»åŠ å¤§å°é™åˆ¶æ£€æŸ¥

```typescript
// realtime.store.ts
recordTraffic(...) {
  // æ·»åŠ å¤§å°æ£€æŸ¥
  if (this.domainByBackend.size > RealtimeStore.MAX_DOMAIN_ENTRIES) {
    this.evictLeastUsedDomains(); // æ·˜æ±°æœ€å°‘ä½¿ç”¨
  }
}
```

---

## å››ã€æ•°æ®ä¸€è‡´æ€§ä¿éšœæœºåˆ¶

### 4.1 åŒå†™ä¸€è‡´æ€§

```typescript
// batch-buffer.ts:137-152
if (!skipSqliteStatsWrites) {
  db.batchUpdateTrafficStats(backendId, updates, reduceSQLiteWrites);
}
if (clickHouseWriter.isEnabled()) {
  pendingTrafficWrite = clickHouseWriter.writeTrafficBatch(backendId, updates);
}
```

- SQLite å†™å…¥æ˜¯åŒæ­¥çš„
- ClickHouse å†™å…¥æ˜¯å¼‚æ­¥çš„ï¼Œè¿”å› Promise
- å¤±è´¥æ—¶ä¿ç•™ RealtimeStore æ•°æ®ï¼Œä¸‹æ¬¡é‡è¯•

### 4.2 æŸ¥è¯¢ä¸€è‡´æ€§

```typescript
// stats.service.ts:321-346
const allCHReady = !!summaryCH && !!topDomainsCH && ...;
if (!allCHReady) {
  // åŸå­å›é€€ï¼šä»»ä¸€å¤±è´¥åˆ™å…¨éƒ¨ä½¿ç”¨ SQLite
  return this.getSummary(backendId, timeRange);
}
```

### 4.3 æ•°æ®æ ¡éªŒæœåŠ¡

```typescript
// clickhouse.compare.ts
// å®šæœŸå¯¹æ¯” SQLite å’Œ ClickHouse çš„æ•°æ®å·®å¼‚
// è¾“å‡º: upload_delta, download_delta
```

---

## äº”ã€é…ç½®è°ƒä¼˜å»ºè®®

### 5.1 ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®

```bash
# SQLite ä¼˜åŒ–
SQLITE_CACHE_MB=128                    # å¢å¤§ç¼“å­˜
SQLITE_WAL_AUTOCHECKPOINT_PAGES=2000   # å‡å°‘checkpointé¢‘ç‡
SQLITE_BUSY_TIMEOUT_MS=10000           # å¢åŠ è¶…æ—¶

# ClickHouse å†™å…¥ä¼˜åŒ–
CH_WRITE_MAX_PENDING_BATCHES=300       # é€‚å½“å¢åŠ é˜Ÿåˆ—
CH_WRITE_MAX_PENDING_ROWS=300000       # å¢åŠ è¡Œæ•°é™åˆ¶

# æŸ¥è¯¢è·¯ç”±
STATS_QUERY_SOURCE=auto                # è‡ªåŠ¨è·¯ç”±
CH_STRICT_STATS=0                      # å…è®¸é™çº§

# RealtimeStore
REALTIME_MAX_MINUTES=240               # å¢åŠ ä¿ç•™æ—¶é—´
```

### 5.2 æç«¯ IO æ•æ„Ÿåœºæ™¯

```bash
# å®Œå…¨å…³é—­ SQLite ç»Ÿè®¡å†™å…¥ï¼ˆä»…ä¿ç•™æ§åˆ¶å¹³é¢æ•°æ®ï¼‰
CH_ONLY_MODE=1
CH_WRITE_ENABLED=1
STATS_QUERY_SOURCE=clickhouse
CH_STRICT_STATS=1                      # å¼ºåˆ¶ä½¿ç”¨CHï¼Œä¸å…è®¸é™çº§
```

---

## å…­ã€æ€»ç»“

### æ¶æ„ä¼˜åŠ¿

1. **æ¸è¿›å¼è¿ç§»**: åŒå†™æ¶æ„å…è®¸å¹³æ»‘è¿‡æ¸¡ï¼Œéšæ—¶å¯å›é€€
2. **è¯»å†™åˆ†ç¦»**: ClickHouse æ‰¿è½½åˆ†ææŸ¥è¯¢ï¼ŒSQLite å¤„ç†äº‹åŠ¡æ€§æ“ä½œ
3. **å¤šå±‚ç¼“å†²**: BatchBuffer â†’ RealtimeStore â†’ Buffer Tableï¼Œå±‚å±‚å‰Šå³°
4. **é™çº§èƒ½åŠ›**: ä»»ä½•ç»„ä»¶æ•…éšœéƒ½æœ‰å…œåº•æ–¹æ¡ˆ

### ä¸»è¦é£é™©

| é£é™© | ç­‰çº§ | å»ºè®®æªæ–½ |
|------|------|----------|
| SQLite åŒå†™å†™æ”¾å¤§ | ä¸­ | æä¾› `CH_ONLY_MODE` å®Œå…¨å…³é—­ç»Ÿè®¡å†™å…¥ |
| ClickHouse è¿æ¥å¼€é”€ | ä½ | å¯ç”¨ HTTP Keep-Alive |
| RealtimeStore æ•°æ®ä¸¢å¤± | ä½ | æ·»åŠ ä¼˜é›…å…³é—­å’Œå¯é€‰ checkpoint |
| Buffer è¡¨é…ç½®ä¿å®ˆ | ä½ | æ ¹æ®å†…å­˜æƒ…å†µå¢å¤§ç¼“å†²å‚æ•° |

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

1. **çŸ­æœŸ**: ç›‘æ§ WAL æ–‡ä»¶å¢é•¿æƒ…å†µï¼Œè¯„ä¼° `CH_ONLY_MODE` å¼€å¯æ¡ä»¶
2. **ä¸­æœŸ**: å®æ–½è¿æ¥å¤ç”¨ï¼Œä¼˜åŒ– ClickHouse å†™å…¥æ€§èƒ½
3. **é•¿æœŸ**: è€ƒè™‘ RealtimeStore æŒä¹…åŒ–æ–¹æ¡ˆï¼Œç¡®ä¿æ•°æ®é›¶ä¸¢å¤±
