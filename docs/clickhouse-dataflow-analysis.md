# ClickHouse æ•°æ®æµåˆ†ææŠ¥å‘Š

> åˆ†æ”¯: `refactor/clickhouse` vs `main`
> åˆ†ææ—¥æœŸ: 2026-02-21

## ä¸€ã€æ•´ä½“æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•°æ®æµæ¶æ„å›¾                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  æ•°æ®æºå¤´                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    WebSocket     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ Clash Gatewayâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚GatewayCollectorâ”‚                          â”‚
â”‚  â”‚ (è¿æ¥æ•°æ®)    â”‚                 â”‚ (deltaè®¡ç®—)     â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                           â”‚                                     â”‚
â”‚                                           â–¼                                     â”‚
â”‚  å¤„ç†å±‚                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                                         â”‚  BatchBuffer   â”‚ â—„â”€â”€ å†…å­˜èšåˆ         â”‚
â”‚                                         â”‚ (åˆ†é’Ÿçº§buffer) â”‚                     â”‚
â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                 â”‚                              â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                         â–¼                       â–¼                       â–¼      â”‚
â”‚  å†™å…¥å±‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                 â”‚ RealtimeStore â”‚      â”‚SQLite Writer  â”‚      â”‚CH Writer    â”‚ â”‚
â”‚                 â”‚ (å®æ—¶ç¼“å­˜)     â”‚      â”‚ (UPSERTäº‹åŠ¡)   â”‚      â”‚ (Bufferè¡¨)  â”‚ â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                      â”‚                     â”‚        â”‚
â”‚                         â”‚                      â–¼                     â–¼        â”‚
â”‚  å­˜å‚¨å±‚                 â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                         â”‚              â”‚    SQLite     â”‚      â”‚ ClickHouse  â”‚ â”‚
â”‚                         â”‚              â”‚ (stats.db)    â”‚      â”‚ (Bufferâ†’MT) â”‚ â”‚
â”‚                         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                      â”‚                     â”‚        â”‚
â”‚                         â–¼                      â–¼                     â–¼        â”‚
â”‚  æŸ¥è¯¢å±‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                 â”‚                    StatsService                          â”‚   â”‚
â”‚                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚                 â”‚  â”‚RealtimeStoreâ”‚ + â”‚ClickHouse   â”‚ + â”‚   SQLite    â”‚    â”‚   â”‚
â”‚                 â”‚  â”‚ (å†…å­˜merge) â”‚   â”‚Reader(ä¸»æŸ¥) â”‚   â”‚Reader(é™çº§) â”‚    â”‚   â”‚
â”‚                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€å„ç¯èŠ‚è¯¦ç»†åˆ†æ

### 1. æ•°æ®æºå¤´ (GatewayCollector)

**å½“å‰å®ç°** (`gateway.collector.ts:136-521`)
- WebSocket è¿æ¥ Clash Gatewayï¼Œæ¥æ”¶ `connections` æ¶ˆæ¯
- è®¡ç®—å¢é‡æµé‡ï¼š`uploadDelta = conn.upload - existing.lastUpload`
- è¿æ¥æ–­å¼€åç§»é™¤è¿½è¸ª

**æ½œåœ¨é—®é¢˜**ï¼š

| é—®é¢˜ | å½±å“ | å»ºè®® |
|------|------|------|
| æ— æ•°æ®æ ¡éªŒ | `metadata.host` å¯èƒ½ä¸ºç©º | âœ… å·²æœ‰é»˜è®¤å€¼å¤„ç† |
| è¿æ¥çŠ¶æ€è·Ÿè¸ªå†…å­˜æ³„æ¼é£é™© | é«˜å¹¶å‘ä¸‹ `activeConnections` Map å¯èƒ½è†¨èƒ€ | âœ… å·²æœ‰ `STALE_CONNECTION_TIMEOUT` æ¸…ç† |

**IO å½±å“**: æ— ç£ç›˜ IOï¼Œçº¯å†…å­˜æ“ä½œ

---

### 2. å¤„ç†å±‚ (BatchBuffer)

**å½“å‰å®ç°** (`batch-buffer.ts:59-210`)
- å†…å­˜èšåˆï¼šæŒ‰ `(backendId, minute, domain, ip, chain, rule)` ç»„åˆé”®èšåˆ
- èšåˆæ—¶æœºï¼šå®šæ—¶ flush (30s) æˆ– buffer æ»¡ (5000æ¡)

**ä¼˜åŒ–äº®ç‚¹**ï¼š

```typescript
// batch-buffer.ts:139-141 - å·²å®ç° SQLite å†™å…¥å‡å°‘
const reduceSQLiteWrites = clickHouseWriter.isEnabled() && 
  process.env.CH_DISABLE_SQLITE_REDUCTION !== '1';
```

**æ½œåœ¨é—®é¢˜**ï¼š

| é—®é¢˜ | å½±å“ | ä¸¥é‡ç¨‹åº¦ |
|------|------|----------|
| åŒå†™æ”¾å¤§ | å³ä½¿å¯ç”¨ ClickHouseï¼Œä»å†™å…¥ SQLite 12+ å¼ è¡¨ | âš ï¸ é«˜ |
| å†…å­˜å‹åŠ› | `buffer.size()` æ— ä¸Šé™ | ä¸­ |

**IO å½±å“**: 
- **å†™å…¥å‰**: æ— ç£ç›˜ IO
- **flush æ—¶**: SQLite äº‹åŠ¡ + ClickHouse HTTP POST

---

### 3. å­˜å‚¨å±‚

#### 3.1 SQLite å†™å…¥ (TrafficWriterRepository)

**å½“å‰å®ç°**ï¼š
- ä½¿ç”¨ `better-sqlite3` äº‹åŠ¡æ‰¹é‡ UPSERT
- å½“ `reduceWrites=true` æ—¶ï¼Œè·³è¿‡éƒ¨åˆ†è¡¨å†™å…¥

**é—®é¢˜åˆ†æ**ï¼š

```
SQLite å†™å…¥è¡¨æ•°é‡ç»Ÿè®¡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ reduceWrites=false (é»˜è®¤)          â”‚ reduceWrites=true (CHå¯ç”¨) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. domain_stats                   â”‚ 1. hourly_stats            â”‚
â”‚ 2. ip_stats                       â”‚ 2. proxy_stats             â”‚
â”‚ 3. proxy_stats âœ“                  â”‚                            â”‚
â”‚ 4. rule_stats                     â”‚                            â”‚
â”‚ 5. rule_chain_traffic             â”‚                            â”‚
â”‚ 6. rule_domain_traffic            â”‚                            â”‚
â”‚ 7. rule_ip_traffic                â”‚                            â”‚
â”‚ 8. hourly_stats âœ“                 â”‚                            â”‚
â”‚ 9. minute_stats                   â”‚                            â”‚
â”‚ 10. minute_dim_stats              â”‚                            â”‚
â”‚ 11. hourly_dim_stats              â”‚                            â”‚
â”‚ 12. domain_proxy_stats            â”‚                            â”‚
â”‚ 13. ip_proxy_stats                â”‚                            â”‚
â”‚ 14. device_stats                  â”‚                            â”‚
â”‚ 15. device_domain_stats           â”‚                            â”‚
â”‚ 16. device_ip_stats               â”‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡: 16 å¼ è¡¨ UPSERT              â”‚ æ€»è®¡: 2 å¼ è¡¨ UPSERT         â”‚
â”‚ IO å†™æ”¾å¤§: é«˜                     â”‚ IO å†™æ”¾å¤§: å¤§å¹…é™ä½         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®å‘ç°**ï¼š

```typescript
// traffic-writer.repository.ts:420-443
// å½“ reduceWrites=true æ—¶ï¼Œä»å†™å…¥ hourly_stats å’Œ proxy_stats
// ä½† minute_stats å’Œ minute_dim_stats è¢«è·³è¿‡äº†ï¼
```

**é—®é¢˜**: `minute_stats` è¢«è·³è¿‡åï¼ŒSQLite çš„ `getTrafficInRange` å°†æ— æ³•æ­£ç¡®è·å–åˆ†é’Ÿçº§æ•°æ®

#### 3.2 ClickHouse å†™å…¥ (ClickHouseWriter)

**æ¶æ„è®¾è®¡**ï¼š

```
å†™å…¥æµç¨‹:
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     ClickHouseWriter             â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
å†™å…¥è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   â”‚  enqueue(task, rows)   â”‚     â”‚
                    â”‚   â”‚  - pendingBatches æ£€æŸ¥  â”‚     â”‚
                    â”‚   â”‚  - pendingRows æ£€æŸ¥     â”‚     â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                    â”‚              â”‚                    â”‚
                    â”‚              â–¼                    â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                    â”‚   â”‚   writeChain (ä¸²è¡Œ)     â”‚     â”‚
                    â”‚   â”‚   Promise.then é“¾å¼    â”‚     â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                    â”‚              â”‚                    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                    â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚traffic_detail_  â”‚  â”‚traffic_agg_     â”‚  â”‚country_buffer   â”‚
    â”‚buffer (Buffer)  â”‚  â”‚buffer (Buffer)  â”‚  â”‚(Buffer)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                    â”‚                    â”‚
             â–¼                    â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚traffic_detail   â”‚  â”‚traffic_agg      â”‚  â”‚country_minute   â”‚
    â”‚(MergeTree)      â”‚  â”‚(SummingMergeTreeâ”‚  â”‚(SummingMergeTreeâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Buffer è¡¨é…ç½®åˆ†æ** (`clickhouse.config.ts:265-302`):

```sql
-- Buffer å‚æ•°:
-- min_time=10s, max_time=60s  â†’ æœ€å¤š60ç§’åˆ·æ–°ä¸€æ¬¡
-- min_rows=100, max_rows=10000 â†’ æœ€å¤šç´¯ç§¯10000è¡Œåˆ·æ–°
-- min_bytes=10KB, max_bytes=1MB â†’ æœ€å¤š1MBåˆ·æ–°
```

**ä¼˜åŒ–äº®ç‚¹**ï¼š
- Buffer è¡¨æœºåˆ¶å°†å†™å…¥é¢‘ç‡ä» ~40æ¬¡/åˆ†é’Ÿ é™ä½åˆ° ~2æ¬¡/åˆ†é’Ÿ
- `SummingMergeTree` è‡ªåŠ¨èšåˆï¼Œé¿å… UPSERT è¯»æ”¾å¤§

**æ½œåœ¨é—®é¢˜**ï¼š

| é—®é¢˜ | å½±å“ | ä¸¥é‡ç¨‹åº¦ |
|------|------|----------|
| å†™å…¥é˜Ÿåˆ—æ»¡æ—¶ä¸¢å¼ƒæ•°æ® | `maxPendingBatches=200` æ—¶å¯èƒ½ä¸¢æ•°æ® | âš ï¸ ä¸­ |
| Buffer è¡¨åˆ·æ–°å»¶è¿Ÿ | æŸ¥è¯¢å¯èƒ½çœ‹ä¸åˆ°æœ€æ–° 60 ç§’æ•°æ® | ä½ (RealtimeStore è¡¥å¿) |

---

### 4. ç¼“å­˜å±‚ (RealtimeStore)

**å½“å‰å®ç°** (`realtime.store.ts`)
- å­˜å‚¨å½“å‰æ‰¹æ¬¡æœª flush çš„æ•°æ®
- æ”¯æŒå†…å­˜é™åˆ¶ï¼š`MAX_DOMAIN_ENTRIES=50000`, `MAX_IP_ENTRIES=50000`
- æ”¯æŒè¿‡æœŸæ¸…ç†ï¼š`maxMinutes=180`

**é—®é¢˜åˆ†æ**ï¼š

```typescript
// realtime.store.ts:1315-1318
clearTrafficSummary(backendId: number): void {
  this.summaryByBackend.delete(backendId);
  this.minuteByBackend.delete(backendId);
}
```

**å…³é”®é€»è¾‘** (`gateway.collector.ts:205-214`):

```typescript
// åªæœ‰ CH å†™å…¥æˆåŠŸæ‰æ¸…é™¤ realtime store
if (trafficDetailOk && trafficAggOk) {
  realtimeStore.clearTraffic(id);
} else if (trafficDetailOk && !trafficAggOk) {
  realtimeStore.clearTrafficDimensions(id);  // åªæ¸…é™¤ç»´åº¦
} else if (!trafficDetailOk && trafficAggOk) {
  realtimeStore.clearTrafficSummary(id);  // åªæ¸…é™¤æ±‡æ€»
}
```

**è®¾è®¡ä¼˜ç‚¹**: å†™å…¥å¤±è´¥æ—¶ä¿ç•™å†…å­˜æ•°æ®ï¼Œä¸‹æ¬¡æŸ¥è¯¢ä»å¯åˆå¹¶è¿”å›

---

### 5. æŸ¥è¯¢è·¯ç”±å±‚ (StatsService)

**å½“å‰å®ç°** (`stats.service.ts`)

**è·¯ç”±ç­–ç•¥**:

```
æŸ¥è¯¢è·¯ç”±å†³ç­–æ ‘:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ shouldUseClickHouse(timeRange)                                  â”‚
â”‚ â”œâ”€â”€ timeRange.active == false â†’ SQLite                          â”‚
â”‚ â””â”€â”€ timeRange.active == true                                    â”‚
â”‚     â””â”€â”€ shouldUseClickHouseForRange(start, end)                 â”‚
â”‚         â”œâ”€â”€ ClickHouse å¯ç”¨ â†’ ClickHouse                        â”‚
â”‚         â””â”€â”€ ClickHouse å¤±è´¥ â†’ SQLite fallback                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜**: `getSummaryWithRouting` éåŸå­å›é€€

```typescript
// stats.service.ts:321-346
const allCHReady =
  !!summaryCH &&
  !!topDomainsCH &&
  !!topIPsCH &&
  // ... å…¶ä»– 7 ä¸ªå¹¶å‘æŸ¥è¯¢

if (!allCHReady) {
  // éƒ¨åˆ†å¤±è´¥æ—¶æ•´ä½“å›é€€åˆ° SQLite
  return this.getSummary(backendId, timeRange);
}
```

**é£é™©**: å¦‚æœ `summaryCH` æˆåŠŸä½† `topDomainsCH` å¤±è´¥ï¼Œæ‰€æœ‰æ•°æ®å›é€€ SQLiteï¼Œå¯èƒ½å¯¼è‡´é¡µé¢é—ªçƒ

---

## ä¸‰ã€IO æ€§èƒ½åˆ†æ

### 1. å†™å…¥è·¯å¾„ IO åˆ†æ

| é˜¶æ®µ | æ“ä½œ | é¢‘ç‡ | IO é‡çº§ |
|------|------|------|---------|
| æ•°æ®é‡‡é›† | WebSocket â†’ å†…å­˜ | å®æ—¶ | 0 |
| BatchBuffer | å†…å­˜èšåˆ | 30s/5000æ¡ | 0 |
| SQLite å†™å…¥ | 16è¡¨ UPSERT äº‹åŠ¡ | 30s | âš ï¸ é«˜ |
| ClickHouse å†™å…¥ | HTTP POST Buffer | 30s | ä½ |

**å½“å‰ä¼˜åŒ–æ•ˆæœ**:
- `reduceWrites=true` æ—¶ SQLite è¡¨ä» 16 â†’ 2 å¼ 
- ClickHouse Buffer è¡¨èšåˆå†™å…¥

### 2. è¯»å–è·¯å¾„ IO åˆ†æ

| æŸ¥è¯¢ç±»å‹ | SQLite (åŸ) | ClickHouse (æ–°) | IO æ”¹å–„ |
|----------|-------------|-----------------|---------|
| Summary | å…¨è¡¨æ‰«æèšåˆ | SummingMergeTree | âœ… æ˜¾è‘— |
| Top Domains | ç´¢å¼•æ‰«æ | åˆ—å­˜èšåˆ | âœ… æ˜¾è‘— |
| Trend | åˆ†é’Ÿè¡¨æ‰«æ | agg è¡¨èšåˆ | âœ… æ˜¾è‘— |
| Chain Flow | å¤šè¡¨ JOIN | å•è¡¨èšåˆ | âœ… æ˜¾è‘— |

---

## å››ã€å‘ç°çš„é—®é¢˜ä¸å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜

#### 1. `minute_stats` å†™å…¥ç¼ºå¤±

**ä½ç½®**: `traffic-writer.repository.ts:446-451`

**é—®é¢˜æè¿°**: å½“ `reduceWrites=true` æ—¶ï¼Œ`minute_stats` è¡¨ä¸å†å†™å…¥ï¼Œä½† SQLite çš„ `getTrafficInRange` ä¾èµ–æ­¤è¡¨ï¼š

```typescript
// db.ts - getTrafficInRange ä¾èµ– minute_stats
const rows = this.db.prepare(`
  SELECT COALESCE(SUM(upload), 0), COALESCE(SUM(download), 0)
  FROM minute_stats WHERE ...
`).get(...);
```

**å½±å“**: å¦‚æœ `timeRange.active=false`ï¼ŒSQLite å›é€€æŸ¥è¯¢å°†è¿”å› 0

**å»ºè®®**: 
- æ–¹æ¡ˆ A: å³ä½¿ `reduceWrites=true` ä¹Ÿä¿ç•™ `minute_stats` å†™å…¥
- æ–¹æ¡ˆ B: `getTrafficInRange` æ”¹ä¸ºæŸ¥è¯¢ ClickHouse

---

#### 2. `hourly_dim_stats` å†™å…¥ç¼ºå¤±

**é—®é¢˜æè¿°**: å½“ `reduceWrites=true` æ—¶ï¼Œ`hourly_dim_stats` ä¸å†™å…¥ï¼Œå¯¼è‡´æŒ‰å°æ—¶ç»´åº¦çš„æŸ¥è¯¢æ— æ³•å›é€€ SQLiteã€‚

**å»ºè®®**: ä¿ç•™å†™å…¥æˆ–ä¿®æ”¹é™çº§é€»è¾‘

---

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜

#### 3. æŸ¥è¯¢è·¯ç”±çš„éåŸå­å›é€€

**ä½ç½®**: `stats.service.ts:321-346`

**é—®é¢˜æè¿°**: å½“å‰å®ç°åœ¨ä»»æ„å­æŸ¥è¯¢å¤±è´¥æ—¶æ•´ä½“å›é€€ã€‚

**å»ºè®®**:
- å¼•å…¥"éƒ¨åˆ†é™çº§"ç­–ç•¥
- æˆ–åœ¨ UI å±‚åš Loading çŠ¶æ€ç»Ÿä¸€

---

#### 4. CH_ONLY_MODE ç¯å¢ƒå˜é‡å†²çª

**ä½ç½®**: `stats-write-mode.ts`

```typescript
export function isClickHouseOnlyModeEnabled(): boolean {
  return process.env.CH_ONLY_MODE === '1';
}
```

**é—®é¢˜æè¿°**: æ–‡æ¡£ä¸­æœªæåŠæ­¤å˜é‡ï¼Œä¸ `CH_WRITE_ENABLED` åŠŸèƒ½é‡å ã€‚

**å»ºè®®**: æ•´ç†ç¯å¢ƒå˜é‡æ–‡æ¡£ï¼Œæ˜ç¡®å„å˜é‡ç”¨é€”

---

### ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜

#### 5. ClickHouse æŸ¥è¯¢å‚æ•°åŒ–

**ä½ç½®**: `clickhouse.reader.ts:1254-1255`

**é—®é¢˜æè¿°**: å½“å‰ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ + `esc()` è½¬ä¹‰ï¼š

```typescript
private esc(value: string): string {
  return value.replace(/\\/g, '\\\\').replace(/'/g, "''");
}
```

**å»ºè®®**: åç»­å¼•å…¥å®˜æ–¹å‚æ•°åŒ–æŸ¥è¯¢

---

## äº”ã€ä¼˜åŒ–å»ºè®®æ±‡æ€»

| ä¼˜å…ˆçº§ | é—®é¢˜ | å»ºè®® | IO å½±å“ |
|--------|------|------|---------|
| ğŸ”´ é«˜ | minute_stats å†™å…¥ç¼ºå¤± | ä¿ç•™å†™å…¥æˆ–ä¿®æ”¹æŸ¥è¯¢é€»è¾‘ | ä¸­ |
| ğŸ”´ é«˜ | hourly_dim_stats ç¼ºå¤± | ä¿ç•™å†™å…¥ | ä¸­ |
| ğŸŸ¡ ä¸­ | éåŸå­å›é€€ | å¼•å…¥éƒ¨åˆ†é™çº§ç­–ç•¥ | æ—  |
| ğŸŸ¡ ä¸­ | ç¯å¢ƒå˜é‡é‡å  | æ•´ç† CH_ONLY_MODE | æ—  |
| ğŸŸ¢ ä½ | å‚æ•°åŒ–æŸ¥è¯¢ | ä½¿ç”¨å®˜æ–¹ API | æ—  |

---

## å…­ã€ç»“è®º

æœ¬æ¬¡ ClickHouse æ”¹é€ åœ¨ **è¯»å– IO** æ–¹é¢å–å¾—äº†æ˜¾è‘—ä¼˜åŒ–ï¼Œé€šè¿‡ `SummingMergeTree` å’Œ Buffer è¡¨æœºåˆ¶ï¼Œå°†åˆ†ææŸ¥è¯¢çš„ IO å‹åŠ›ä» SQLite è½¬ç§»åˆ°äº†æ›´é€‚åˆçš„ ClickHouseã€‚

ä½†åœ¨ **å†™å…¥è·¯å¾„** å­˜åœ¨ä»¥ä¸‹é£é™©ï¼š
1. `reduceWrites=true` æ—¶ SQLite å…³é”®è¡¨ç¼ºå¤±å†™å…¥
2. å®Œå…¨ä¾èµ– ClickHouse æ—¶ï¼Œå¦‚æœ CH ä¸å¯ç”¨ï¼Œéƒ¨åˆ†æŸ¥è¯¢å°†æ— æ³•é™çº§

**å»ºè®®**:
1. åœ¨ `reduceWrites=true` æ¨¡å¼ä¸‹ï¼Œä»ä¿ç•™ `minute_stats` å’Œ `hourly_dim_stats` çš„å†™å…¥
2. æˆ–è€…åœ¨æŸ¥è¯¢å±‚åšæ›´ç²¾ç»†çš„é™çº§é€»è¾‘ï¼Œé¿å…æ•°æ®ç©ºæ´

---

## é™„å½•ï¼šç›¸å…³æ–‡ä»¶ç´¢å¼•

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ |
|------|----------|
| ClickHouse Writer | `apps/collector/src/modules/clickhouse/clickhouse.writer.ts` |
| ClickHouse Reader | `apps/collector/src/modules/clickhouse/clickhouse.reader.ts` |
| ClickHouse Config | `apps/collector/src/modules/clickhouse/clickhouse.config.ts` |
| BatchBuffer | `apps/collector/src/modules/collector/batch-buffer.ts` |
| Gateway Collector | `apps/collector/src/modules/collector/gateway.collector.ts` |
| RealtimeStore | `apps/collector/src/modules/realtime/realtime.store.ts` |
| StatsService | `apps/collector/src/modules/stats/stats.service.ts` |
| Stats Write Mode | `apps/collector/src/modules/stats/stats-write-mode.ts` |
| TrafficWriterRepository | `apps/collector/src/database/repositories/traffic-writer.repository.ts` |
| CleanupService | `apps/collector/src/modules/cleanup/cleanup.service.ts` |
